syntax = "proto3";

package controller;

option go_package = "github.com/UpperMoon0/game-server-proto/gen";

import "proto/common.proto";

// Node Service - Handles node registration and communication
service NodeService {
    // Register a new node with the controller
    rpc RegisterNode(RegisterNodeRequest) returns (RegisterNodeResponse);
    
    // Establish bidirectional streaming for events and commands
    rpc StreamEvents(stream NodeEvent) returns (stream ControllerCommand);
    
    // Update node status and metrics
    rpc UpdateNodeStatus(UpdateNodeStatusRequest) returns (UpdateNodeStatusResponse);
    
    // Get node configuration from controller
    rpc GetNodeConfig(GetNodeConfigRequest) returns (GetNodeConfigResponse);
}

// Server Service - Handles game server lifecycle management
service ServerService {
    // Create a new game server on a node
    rpc CreateServer(CreateServerRequest) returns (CreateServerResponse);
    
    // Update server configuration
    rpc UpdateServer(UpdateServerRequest) returns (UpdateServerResponse);
    
    // Delete a server
    rpc DeleteServer(DeleteServerRequest) returns (DeleteServerResponse);
    
    // Start a server
    rpc StartServer(StartServerRequest) returns (StartServerResponse);
    
    // Stop a server
    rpc StopServer(StopServerRequest) returns (StopServerResponse);
    
    // Get server current status
    rpc GetServerStatus(GetServerStatusRequest) returns (GetServerStatusResponse);
    
    // Stream server logs in real-time
    rpc StreamServerLogs(StreamLogsRequest) returns (stream LogEntry);
}

// File Service - Handles file operations on nodes
service FileService {
    // List files in a directory
    rpc ListFiles(FileListRequest) returns (FileListResponse);
    
    // Create a file or directory
    rpc CreateFile(FileCreateRequest) returns (FileOperationResponse);
    
    // Delete a file or directory
    rpc DeleteFile(FileDeleteRequest) returns (FileOperationResponse);
    
    // Rename a file or directory
    rpc RenameFile(FileRenameRequest) returns (FileOperationResponse);
    
    // Move a file or directory
    rpc MoveFile(FileMoveRequest) returns (FileOperationResponse);
    
    // Copy a file or directory
    rpc CopyFile(FileCopyRequest) returns (FileOperationResponse);
    
    // Read file content
    rpc ReadFile(FileReadRequest) returns (FileReadResponse);
    
    // Write file content
    rpc WriteFile(FileWriteRequest) returns (FileOperationResponse);
    
    // Check if file exists
    rpc FileExists(FileExistsRequest) returns (FileExistsResponse);
    
    // Create directory
    rpc Mkdir(FileMkdirRequest) returns (FileOperationResponse);
    
    // Zip files/folders
    rpc ZipFiles(FileZipRequest) returns (FileOperationResponse);
    
    // Unzip archive
    rpc UnzipFiles(FileUnzipRequest) returns (FileOperationResponse);
}

// Message Definitions

message RegisterNodeRequest {
    string node_id = 1;
    string hostname = 2;
    string ip_address = 3;
    NodeResources resources = 4;
    repeated string supported_games = 5;
    string os_version = 6;
    string agent_version = 7;
    bool initialized = 8;
    string game_type = 9;
}

message RegisterNodeResponse {
    string controller_id = 1;
    int64 heartbeat_interval_seconds = 2;
    repeated ServerAssignment pending_servers = 3;
    ControllerConfig controller_config = 4;
}

message NodeEvent {
    string node_id = 1;
    EventType type = 2;
    int64 timestamp = 3;
    oneof payload {
        NodeStatus status = 4;
        ServerStatus server_status = 5;
        MetricsSnapshot metrics = 6;
        LogEntry log = 7;
        ErrorInfo error = 8;
        FileOperationResult file_result = 9;
        CommandResult command_result = 10;
    }
}

enum EventType {
    EVENT_TYPE_UNSPECIFIED = 0;
    EVENT_TYPE_NODE_ONLINE = 1;
    EVENT_TYPE_NODE_OFFLINE = 2;
    EVENT_TYPE_NODE_STATUS_UPDATE = 3;
    EVENT_TYPE_SERVER_CREATED = 4;
    EVENT_TYPE_SERVER_STARTED = 5;
    EVENT_TYPE_SERVER_STOPPED = 6;
    EVENT_TYPE_SERVER_ERROR = 7;
    EVENT_TYPE_METRICS_UPDATE = 8;
    EVENT_TYPE_LOG = 9;
    EVENT_TYPE_HEARTBEAT = 10;
    EVENT_TYPE_FILE_OPERATION_RESULT = 11;
    EVENT_TYPE_COMMAND_RESULT = 12;
    EVENT_TYPE_NODE_INITIALIZING = 13;
    EVENT_TYPE_NODE_READY = 14;
}

message ControllerCommand {
    string command_id = 1;
    string server_id = 2;
    CommandType type = 3;
    int64 timestamp = 4;
    oneof payload {
        InitializeNodeCommand initialize_node = 22;
        CreateServerCommand create_server = 5;
        UpdateServerCommand update_server = 6;
        DeleteServerCommand delete_server = 7;
        StartServerCommand start_server = 8;
        StopServerCommand stop_server = 9;
        FileListCommand file_list = 10;
        FileCreateCommand file_create = 11;
        FileDeleteCommand file_delete = 12;
        FileRenameCommand file_rename = 13;
        FileMoveCommand file_move = 14;
        FileCopyCommand file_copy = 15;
        FileWriteCommand file_write = 16;
        FileReadCommand file_read = 17;
        FileZipCommand file_zip = 18;
        FileUnzipCommand file_unzip = 19;
        FileExistsCommand file_exists = 20;
        FileMkdirCommand file_mkdir = 21;
    }
}

message InitializeNodeCommand {
    string game_type = 1;
}

enum CommandType {
    COMMAND_TYPE_UNSPECIFIED = 0;
    COMMAND_TYPE_INITIALIZE_NODE = 1;
    COMMAND_TYPE_CREATE_SERVER = 2;
    COMMAND_TYPE_UPDATE_SERVER = 3;
    COMMAND_TYPE_DELETE_SERVER = 4;
    COMMAND_TYPE_START_SERVER = 5;
    COMMAND_TYPE_STOP_SERVER = 6;
    COMMAND_TYPE_RESTART_SERVER = 7;
    COMMAND_TYPE_EXECUTE_COMMAND = 8;
    COMMAND_TYPE_FILE_LIST = 10;
    COMMAND_TYPE_FILE_CREATE = 11;
    COMMAND_TYPE_FILE_DELETE = 12;
    COMMAND_TYPE_FILE_RENAME = 13;
    COMMAND_TYPE_FILE_MOVE = 14;
    COMMAND_TYPE_FILE_COPY = 15;
    COMMAND_TYPE_FILE_WRITE = 16;
    COMMAND_TYPE_FILE_READ = 17;
    COMMAND_TYPE_FILE_ZIP = 18;
    COMMAND_TYPE_FILE_UNZIP = 19;
    COMMAND_TYPE_FILE_EXISTS = 20;
    COMMAND_TYPE_FILE_MKDIR = 21;
}

message CreateServerCommand {
    string server_id = 1;
    string game_type = 2;
    ServerConfig config = 3;
    ResourceRequirements requirements = 4;
}

message UpdateServerCommand {
    string server_id = 1;
    ServerConfig config = 2;
    bool restart_required = 3;
}

message DeleteServerCommand {
    string server_id = 1;
    bool backup_before_delete = 2;
}

message StartServerCommand {
    string server_id = 1;
    map<string, string> environment = 2;
}

message StopServerCommand {
    string server_id = 1;
    int32 grace_period_seconds = 2;
    string reason = 3;
}

// File Commands for bidirectional streaming

message FileListCommand {
    string path = 1;
    bool recursive = 2;
}

message FileCreateCommand {
    string path = 1;
    bool is_directory = 2;
}

message FileDeleteCommand {
    string path = 1;
    bool recursive = 2;
}

message FileRenameCommand {
    string old_path = 1;
    string new_path = 2;
}

message FileMoveCommand {
    string source_path = 1;
    string dest_path = 2;
}

message FileCopyCommand {
    string source_path = 1;
    string dest_path = 2;
    bool recursive = 3;
}

message FileWriteCommand {
    string path = 1;
    bytes content = 2;
    bool append = 3;
}

message FileReadCommand {
    string path = 1;
    int64 offset = 2;
    int64 length = 3;
}

message FileZipCommand {
    string source_path = 1;
    string dest_path = 2;
    bool recursive = 3;
}

message FileUnzipCommand {
    string source_path = 1;
    string dest_path = 2;
}

message FileExistsCommand {
    string path = 1;
}

message FileMkdirCommand {
    string path = 1;
    bool parents = 2;
}

// File Service Request/Response Messages

message FileListRequest {
    string node_id = 1;
    string path = 2;
    bool recursive = 3;
}

message FileListResponse {
    bool success = 1;
    string error = 2;
    repeated FileInfo files = 3;
    string current_path = 4;
}

message FileCreateRequest {
    string node_id = 1;
    string path = 2;
    bool is_directory = 3;
}

message FileDeleteRequest {
    string node_id = 1;
    string path = 2;
    bool recursive = 3;
}

message FileRenameRequest {
    string node_id = 1;
    string old_path = 2;
    string new_path = 3;
}

message FileMoveRequest {
    string node_id = 1;
    string source_path = 2;
    string dest_path = 3;
}

message FileCopyRequest {
    string node_id = 1;
    string source_path = 2;
    string dest_path = 3;
    bool recursive = 4;
}

message FileReadRequest {
    string node_id = 1;
    string path = 2;
    int64 offset = 3;
    int64 length = 4;
}

message FileReadResponse {
    bool success = 1;
    string error = 2;
    bytes content = 3;
    int64 total_size = 4;
}

message FileWriteRequest {
    string node_id = 1;
    string path = 2;
    bytes content = 3;
    bool append = 4;
}

message FileExistsRequest {
    string node_id = 1;
    string path = 2;
}

message FileExistsResponse {
    bool success = 1;
    string error = 2;
    bool exists = 3;
    bool is_directory = 4;
}

message FileMkdirRequest {
    string node_id = 1;
    string path = 2;
    bool parents = 3;
}

message FileZipRequest {
    string node_id = 1;
    string source_path = 2;
    string dest_path = 3;
    bool recursive = 4;
}

message FileUnzipRequest {
    string node_id = 1;
    string source_path = 2;
    string dest_path = 3;
}

message FileOperationResponse {
    bool success = 1;
    string error = 2;
    string message = 3;
}

message ServerConfig {
    string name = 1;
    string version = 2;
    map<string, string> settings = 3;
    repeated string mods = 4;
    int32 max_players = 5;
    string world_name = 6;
    bool online_mode = 7;
    string query_type = 8;
}

message ResourceRequirements {
    int32 min_cpu_cores = 1;
    int64 min_memory_mb = 2;
    int64 min_storage_mb = 3;
    int32 max_cpu_cores = 4;
    int64 max_memory_mb = 5;
    int32 max_players = 6;
    int32 network_bandwidth_mbps = 7;
}

message NodeResources {
    int32 total_cpu_cores = 1;
    int64 total_memory_mb = 2;
    int64 total_storage_mb = 3;
    int32 available_cpu_cores = 4;
    int64 available_memory_mb = 5;
    int64 available_storage_mb = 6;
    string cpu_model = 7;
    string network_interface = 8;
    int64 network_speed_mbps = 9;
}

message NodeStatus {
    string node_id = 1;
    NodeHealth health = 2;
    NodeResources resources = 3;
    int64 uptime_seconds = 4;
    int32 active_servers = 5;
    int32 queued_tasks = 6;
    int64 timestamp = 7;
}

enum NodeHealth {
    NODE_HEALTH_UNSPECIFIED = 0;
    NODE_HEALTH_HEALTHY = 1;
    NODE_HEALTH_DEGRADED = 2;
    NODE_HEALTH_UNHEALTHY = 3;
    NODE_HEALTH_CRITICAL = 4;
}

message ServerStatus {
    string server_id = 1;
    ServerState state = 2;
    int32 player_count = 3;
    repeated string online_players = 4;
    int64 uptime_seconds = 5;
    int32 cpu_usage_percent = 6;
    int64 memory_usage_mb = 7;
    int32 tps = 8;
    int32 mspt = 9;
    int64 timestamp = 10;
}

enum ServerState {
    SERVER_STATE_UNSPECIFIED = 0;
    SERVER_STATE_INSTALLING = 1;
    SERVER_STATE_CONFIGURING = 2;
    SERVER_STATE_STARTING = 3;
    SERVER_STATE_RUNNING = 4;
    SERVER_STATE_STOPPING = 5;
    SERVER_STATE_STOPPED = 6;
    SERVER_STATE_ERROR = 7;
    SERVER_STATE_BACKING_UP = 8;
    SERVER_STATE_UPDATING = 9;
}

message MetricsSnapshot {
    string node_id = 1;
    float cpu_usage_percent = 2;
    float memory_usage_percent = 3;
    float storage_usage_percent = 4;
    int64 network_bytes_in = 5;
    int64 network_bytes_out = 6;
    int32 active_connections = 7;
    int64 timestamp = 8;
}

message LogEntry {
    string server_id = 1;
    LogLevel level = 2;
    string message = 3;
    string source = 4;
    int64 timestamp = 5;
    int32 line_number = 6;
}

enum LogLevel {
    LOG_LEVEL_UNSPECIFIED = 0;
    LOG_LEVEL_DEBUG = 1;
    LOG_LEVEL_INFO = 2;
    LOG_LEVEL_WARNING = 3;
    LOG_LEVEL_ERROR = 4;
    LOG_LEVEL_FATAL = 5;
}

message ErrorInfo {
    string code = 1;
    string message = 2;
    string details = 3;
    string stack_trace = 4;
}

// Request/Response Messages

message UpdateNodeStatusRequest {
    string node_id = 1;
    NodeStatus status = 2;
}

message UpdateNodeStatusResponse {
    bool success = 1;
    string message = 2;
}

message GetNodeConfigRequest {
    string node_id = 1;
}

message GetNodeConfigResponse {
    ControllerConfig config = 1;
}

message ControllerConfig {
    string controller_address = 1;
    int32 grpc_port = 2;
    int32 rest_port = 3;
    int64 metrics_interval_seconds = 4;
    bool auto_update_enabled = 5;
}

message CreateServerRequest {
    string node_id = 1;
    string game_type = 2;
    ServerConfig config = 3;
    ResourceRequirements requirements = 4;
}

message CreateServerResponse {
    bool success = 1;
    string server_id = 2;
    string message = 3;
    ServerInfo info = 4;
}

message ServerInfo {
    string server_id = 1;
    string node_id = 2;
    int32 port = 3;
    string rcon_address = 4;
    int32 rcon_port = 5;
}

message UpdateServerRequest {
    string server_id = 1;
    ServerConfig config = 2;
    bool restart = 3;
}

message UpdateServerResponse {
    bool success = 1;
    string message = 2;
}

message DeleteServerRequest {
    string server_id = 1;
    bool backup = 2;
}

message DeleteServerResponse {
    bool success = 1;
    string message = 2;
    string backup_path = 3;
}

message StartServerRequest {
    string server_id = 1;
}

message StartServerResponse {
    bool success = 1;
    string message = 2;
}

message StopServerRequest {
    string server_id = 1;
    int32 grace_period = 2;
}

message StopServerResponse {
    bool success = 1;
    string message = 2;
}

message GetServerStatusRequest {
    string server_id = 1;
}

message GetServerStatusResponse {
    ServerStatus status = 1;
}

message StreamLogsRequest {
    string server_id = 1;
    LogLevel min_level = 2;
    int32 tail_lines = 3;
    bool follow = 4;
}

message StreamMetricsRequest {
    string node_id = 1;
    int64 interval_ms = 2;
}

message NodeMetrics {
    string node_id = 1;
    float cpu_usage = 2;
    float memory_usage = 3;
    float storage_usage = 4;
    int64 network_in = 5;
    int64 network_out = 6;
    int32 load_average = 7;
    int64 timestamp = 8;
}

message ServerAssignment {
    string server_id = 1;
    string game_type = 2;
    ServerConfig config = 3;
}
